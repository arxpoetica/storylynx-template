<svelte:window bind:scrollY on:scroll={rejigger} on:resize={rejigger}/>

<div
	class="magnifier"
	bind:this={box}
	on:mousemove={mousemove}
	on:mouseenter={() => show = true}
	on:mouseleave={() => show = false}
>
	<slot></slot>
	{#if loaded}
		<div class:show class="view" style={view_style}></div>
	{/if}
</div>
<p>scrollY: {scrollY}</p>
<p>pos.x: {pos.x}</p>
<p>pos.y: {pos.y}</p>
<p>width: {width}</p>
<p>height: {height}</p>
<p>bounds: {JSON.stringify(bounds)}</p>

<script>
	export let loaded
	export let src
	export let alt
	export let width
	export let height

	let show = false

	let box
	$: bounds = box ? box.getBoundingClientRect() : false
	let scrollY
	let pos = { x: width / 2, y: height / 2 }
	const mousemove = event => {
		view_x = event.clientX - bounds.left
		view_y = event.clientY - bounds.top
	}

	let view_x = 0
	let view_y = 0
	$: view_style = [
		'transform:',
		` translateX(${view_x}rem)`,
		` translateY(${view_y}rem);`,
		`background-image:url(${src});`,
	].join('')

	const rejigger = () => bounds = box.getBoundingClientRect()
</script>

<style type="text/scss">
	.magnifier {
		position: relative;
	}
	.view {
		overflow: hidden;
		position: absolute;
		top: -100rem;
		left: -100rem;
		width: 200rem;
		height: 200rem;
		background: none no-repeat 0 0 $black;
		border-radius: 100%;
		box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
		transition: opacity 0.2s ease-in-out;
		opacity: 0;
		z-index: 2;
		pointer-events: none;
		&.show {
			opacity: 1;
		}
	}
</style>
